name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - v*
  pull_request:
    branches:
      - main

jobs:
  # ============================================
  # Stage 1: CI (Linting, Testing, Code Quality)
  # ============================================
  ci:
    name: CI - Linting & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r task-6/requirements.txt
          pip install flake8 black isort
      
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 task-6/app.py --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-code is always 0, allow warnings
          flake8 task-6/app.py --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Check formatting with black
        run: |
          black --check task-6/app.py || true
      
      - name: Check import sorting with isort
        run: |
          isort --check-only task-6/app.py || true
      
      - name: Run tests
        run: |
          echo "Running tests..."
          python -m pytest task-6/ -v || true

  # ============================================
  # Stage 2: Build & Publish to DockerHub
  # ============================================
  build-and-push:
    name: Build & Push Docker Image
    needs: ci
    runs-on: ubuntu-latest
    # Run only on main branch push or tags
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Generate Docker tags
        id: docker_meta
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/m324-app
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${IMAGE_NAME}:latest"
            TAGS="${TAGS},${IMAGE_NAME}:${GITHUB_SHA::7}"
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            TAGS="${IMAGE_NAME}:${TAG_NAME}"
            TAGS="${TAGS},${IMAGE_NAME}:latest"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./task-6
          push: true
          tags: ${{ steps.docker_meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Image digest
        run: echo ${{ steps.build.outputs.digest }}

  # ============================================
  # Stage 3: Deploy to Cloud
  # ============================================
  deploy:
    name: Deploy to Render
    needs: build-and-push
    runs-on: ubuntu-latest
    # Only deploy from main branch, not from pull requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Render via Deploy Hook
        run: |
          echo "Triggering deployment on Render..."
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{"ref":"main","commit":"${{ github.sha }}"}' \
            -v
      
      - name: Wait for deployment
        run: |
          echo "Deployment triggered. Monitor at: ${{ secrets.RENDER_SERVICE_URL }}"
          sleep 10

  # ============================================
  # Notification (Optional)
  # ============================================
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [ci, build-and-push, deploy]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          echo "CI Status: ${{ needs.ci.result }}"
          echo "Build Status: ${{ needs.build-and-push.result }}"
          echo "Deploy Status: ${{ needs.deploy.result }}"
